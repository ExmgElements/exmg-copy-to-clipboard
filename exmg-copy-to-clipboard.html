<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../polymer/lib/utils/flattened-nodes-observer.html">

<!--
`exmg-copy-to-clipboard`
Helper element to create icon/buttons that lets the user copy content to the clipboard. Just wrap it arround
the button or icon and set the value that needs to be copied.

```html
  <exmg-copy-to-clipboard value="mark@test.com">
    <paper-icon-button icon="content-copy"></paper-icon-button>
  </exmg-copy-to-clipboard>
```

### Styling

Custom property | Description | Default
----------------|-------------|----------
`--exmg-copy-to-clipboard` | Mixin applied to host element | `{}`

@demo demo/index.html
-->

<dom-module id="exmg-copy-to-clipboard">
  <template>
    <style>
      :host {
        display: inline-block;
        @apply(--exmg-copy-to-clipboard);
      }
    </style>
    <slot></slot>
    <span id="clipboard" style="display:none;">[[value]]</span>
  </template>

  <script>
    class ExmgCopyToClipboard extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return 'exmg-copy-to-clipboard';
      }
      static get properties() {
        return {
          /**
           * Value used for the copy
           */
          value: {
            type: String
          },
          /**
           * Boolean indicating if document.execCommand('copy') is supported
           */
          _isCopySupported: {
            type: Boolean,
            value: document.queryCommandSupported('copy')
          },
        };
      }
      static get observers() {
        return [
          '_hideCopy(_isCopySupported, _buttonElement)',
        ];
      }
      /**
       * Monitor if button is replaced at a later moment and as a result update reference
       */
      connectedCallback() {
        super.connectedCallback();
        this._boundIconClick = this._handleCopy.bind(this);
        this._observer = new Polymer.FlattenedNodesObserver(this, (info) => {
          console.log('asdasdasd');
          if (info.addedNodes.length > 0) {
            this._buttonElement = info.addedNodes[0];
            console.log('asdasdasd add tap');
            this._buttonElement.addEventListener('tap', this._boundIconClick);
          }
        });
      }
      /**
       * Cleanup node observer
       */
      disconnectCallback() {
        super.disconnectCallback();
        if (this._observer) {
          this._observer = null;
        }
        if (this._buttonElement) {
          this._buttonElement.removeEventListener('tap', this._boundIconClick);
        }
      }
      /**
       * Copy the given value to the clipboard
       */
      copyToClipboard() {
        this.$.clipboard.style.display = 'block';
        var range = document.createRange();
        range.selectNodeContents(this.$.clipboard);
        var selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        try {
          document.execCommand('copy');
          this.dispatchEvent(new CustomEvent('copy-not-supported', {detail: this.value, bubbles: true, composed: true}));
        } catch (err) {
          console.log('copy to clipboard failed', err);
        }
        selection.removeAllRanges();
        this.$.clipboard.style.display = 'none';
      }
      /**
       * Hide button when copy functionality is not supported in browser
       */
      _hideCopy(_isCopySupported, _buttonElement) {
        if (!_isCopySupported && _buttonElement) {
          _buttonElement.setAttribute('hidden', '');
          this.dispatchEvent(new CustomEvent('copy-not-supported', {bubbles: true, composed: true}));
        }
      }
      /**
       * Handle button tap event and trigger the actual copy to clipboard
       */
      _handleCopy(e) {
        console.log('_handleCopy');
        this.copyToClipboard();
        e.stopPropagation();
      }
    }

    window.customElements.define(ExmgCopyToClipboard.is, ExmgCopyToClipboard);
  </script>
</dom-module>
